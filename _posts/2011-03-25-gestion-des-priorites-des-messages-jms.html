---
layout: post
title: Gestion des priorités des messages JMS
date: 2011-03-25 14:40:02.000000000 +01:00
comments: true
categories:
- developpement
tags:
- activemq
- java
- jboss messaging
- jee
- jms
- maven
status: publish
type: post
published: true
meta:
  _edit_last: '17000744'
  _wpas_skip_fb: '1'
  _wpas_done_twitter: '1'
  _oembed_9dd94a6960297817475920fe7054075b: '{{unknown}}'
  _oembed_e672ca5e6990edc170acceb21ee36532: '{{unknown}}'
  _oembed_d1165906b94c466234d59cd212bbe123: '{{unknown}}'
  _oembed_56ea293f6b5095189ed8794687ed06af: '{{unknown}}'
  _oembed_18b8aa78fba5405644c9b12720709570: '{{unknown}}'
  _oembed_7aadb2ba435a07d7b34bb1438a5f5646: '{{unknown}}'
  _oembed_31f79cadb57f713eb581d3570dcb5f2c: '{{unknown}}'
  _oembed_e1c477499602b7ac2d54ee3fbf0adce8: '{{unknown}}'
  _oembed_297869b80c06952a728cbd9232d0b743: '{{unknown}}'
  _oembed_75e3cd53dd78fe06f2bf541a2bef4b27: '{{unknown}}'
  _oembed_11660d6e4ef2845a3d9fbf797f45c77b: '{{unknown}}'
  _oembed_2f49bc252e9b2391e8ce69f043ae5ff9: '{{unknown}}'
  _oembed_aaeab3cf2fa04da6d14bba9bf8fdb7b7: '{{unknown}}'
  _oembed_65240ea6bc0d6366547e669df91b754f: '{{unknown}}'
  _oembed_e984417f29d5f873095c221fd0fd1ac3: '{{unknown}}'
  _oembed_121a998f52f3d367fce6ba8c9aafef8e: '{{unknown}}'
  _oembed_356f92906f51dbbbeb3e7202f8e58266: '{{unknown}}'
  _oembed_3e2b20359742b143c88a507e26c4f687: '{{unknown}}'
  _oembed_bb608a55fee7ee1969f29376d9f36e06: '{{unknown}}'
  _oembed_f50580e6a22f265f25ca9ac4d07aa645: '{{unknown}}'
  _oembed_15b829df8cdaece25383c90905d66a91: '{{unknown}}'
  _oembed_c98c4a3d1d3df5da90ad29e68b7dc882: '{{unknown}}'
  _oembed_22805208231bf4e3929688ee9e06a3a1: '{{unknown}}'
  _oembed_aa9c2e764f898028b3c30b389d0741d2: '{{unknown}}'
  _oembed_8a06491be00ea25b0ac21b66508ccc0f: '{{unknown}}'
  _oembed_3166964b59f2033e53ec80a8c3642cdf: '{{unknown}}'
  _oembed_cd8f7ea656f7aa632536f7bef9f74cbe: '{{unknown}}'
author:
  login: vdupain
  email: vdupain@gmail.com
  display_name: vdupain
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<h1>Objectif</h1>
<p>Ce Quick Start Guide JMS a pour but de montrer simplement comment poster des messages dans une file JMS et de les consommer par ordre de priorité comme illustré par le schéma suivant:</p>
<p><a href="http://www.eaipatterns.com/Resequencer.html"><img class="aligncenter size-full wp-image-183" title="Resequencer" src="{{ site.url }}/assets/resequencer.gif" alt="" width="403" height="106" /></a></p>
<p>Cet exemple a été réalisé et testé dans l'environnement suivant:</p>
<ul>
<li>Java 6</li>
<li>Maven 2.2.1 et 3.0.2</li>
<li>Provider JMS ActiveMQ 5.4.2: la priorité des message est fonctionnelle depuis la version <a href="http://activemq.apache.org/new-features-in-54.html">5.4.0</a></li>
<li>Provider JMS JBoss Messaging 1.4.0.x (demande à uploader certaines librairies dans son repo local maven car non disponibles dans le repo central et le <a href="http://repository.jboss.org/maven2/">repo JBoss</a>)</li>
</ul>
<h1>La partie Développement</h1>
<h2>Création du projet avec Maven</h2>
<p>Tout d'abord, nous allons créer un projet <strong>maven</strong> avec le plugin <strong>archetype</strong>:</p>
<pre>$ mvn --batch-mode archetype:generate -DarchetypeArtifactId=maven-archetype-quickstart -DgroupId=com.mycompany.messaging -DartifactId=messaging -Dversion=1.0.0</pre>
<h3>Configuration du pom.xml</h3>
<p>Il faut ensuite modifier le fichier <strong>pom.xml</strong> pour:</p>
<ul>
<li>ajouter les dépendances vers les librairies JMS et le provider JMS ActiveMQ</li>
<li>ajouter la configuration du plugin ActiveMQ pour lancer le provider JMS</li>
</ul>
<p>[sourcecode language="xml"]<br />
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br />
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;<br />
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br />
  &lt;groupId&gt;com.mycompany.messaging&lt;/groupId&gt;<br />
  &lt;artifactId&gt;messaging&lt;/artifactId&gt;<br />
  &lt;packaging&gt;jar&lt;/packaging&gt;<br />
  &lt;version&gt;1.0.0&lt;/version&gt;<br />
  &lt;name&gt;messaging&lt;/name&gt;<br />
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;<br />
  &lt;dependencies&gt;<br />
    &lt;dependency&gt;<br />
      &lt;groupId&gt;junit&lt;/groupId&gt;<br />
      &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />
      &lt;version&gt;3.8.1&lt;/version&gt;<br />
      &lt;scope&gt;test&lt;/scope&gt;<br />
    &lt;/dependency&gt;<br />
    &lt;dependency&gt;<br />
      &lt;groupId&gt;javax.jms&lt;/groupId&gt;<br />
      &lt;artifactId&gt;jms&lt;/artifactId&gt;<br />
      &lt;version&gt;1.1&lt;/version&gt;<br />
    &lt;/dependency&gt;<br />
    &lt;dependency&gt;<br />
      &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;<br />
      &lt;artifactId&gt;activemq-core&lt;/artifactId&gt;<br />
      &lt;version&gt;5.4.2&lt;/version&gt;<br />
    &lt;/dependency&gt;<br />
  &lt;/dependencies&gt;<br />
  &lt;build&gt;<br />
    &lt;plugins&gt;<br />
      &lt;plugin&gt;<br />
        &lt;groupId&gt;org.apache.activemq.tooling&lt;/groupId&gt;<br />
        &lt;artifactId&gt;maven-activemq-plugin&lt;/artifactId&gt;<br />
        &lt;version&gt;5.4.2&lt;/version&gt;<br />
        &lt;configuration&gt;<br />
          &lt;configUri&gt;xbean:file:./conf/activemq.xml&lt;/configUri&gt;<br />
          &lt;fork&gt;false&lt;/fork&gt;<br />
          &lt;systemProperties&gt;<br />
            &lt;property&gt;<br />
              &lt;name&gt;javax.net.ssl.keyStorePassword&lt;/name&gt;<br />
              &lt;value&gt;password&lt;/value&gt;<br />
            &lt;/property&gt;<br />
            &lt;property&gt;<br />
              &lt;name&gt;org.apache.activemq.default.directory.prefix&lt;/name&gt;<br />
              &lt;value&gt;./target/&lt;/value&gt;<br />
            &lt;/property&gt;<br />
          &lt;/systemProperties&gt;<br />
        &lt;/configuration&gt;<br />
        &lt;dependencies&gt;<br />
          &lt;dependency&gt;<br />
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br />
            &lt;artifactId&gt;spring&lt;/artifactId&gt;<br />
            &lt;version&gt;2.5.5&lt;/version&gt;<br />
          &lt;/dependency&gt;<br />
          &lt;dependency&gt;<br />
            &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />
            &lt;artifactId&gt;jetty-xbean&lt;/artifactId&gt;<br />
            &lt;version&gt;6.1.11&lt;/version&gt;<br />
          &lt;/dependency&gt;<br />
          &lt;dependency&gt;<br />
            &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;<br />
            &lt;artifactId&gt;camel-activemq&lt;/artifactId&gt;<br />
            &lt;version&gt;1.1.0&lt;/version&gt;<br />
          &lt;/dependency&gt;<br />
        &lt;/dependencies&gt;<br />
      &lt;/plugin&gt;<br />
    &lt;/plugins&gt;<br />
  &lt;/build&gt;<br />
&lt;/project&gt;<br />
[/sourcecode]</p>
<h3>Le plugin maven-activemq-plugin</h3>
<p>ActiveMQ fournit un plugin maven 2 <strong>maven-activemq-plugin</strong> pour démarrer facilement un provider JMS. La configuration de ce plugin étant déjà faite dans le fichier pom.xml, il reste à créer un fichier de configuration <strong>activemq.xml</strong> dans un répertoire <strong>conf</strong> à la racine de notre projet.</p>
<p>Créer un fichier conf/activemq.xml:</p>
<p>[sourcecode language="xml"]<br />
&lt;?xml version=&quot;1.0&quot;?&gt;<br />
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:amq=&quot;http://activemq.apache.org/schema/core&quot;<br />
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br />
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br />
  http://www.springframework.org/schema/beans/spring-beans-2.0.xsd<br />
  http://activemq.apache.org/schema/core<br />
  http://activemq.apache.org/schema/core/activemq-core.xsd<br />
  &quot;&gt;<br />
  &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;localhost&quot; dataDirectory=&quot;./data&quot;&gt;<br />
    &lt;!-- The transport connectors ActiveMQ will listen to --&gt;<br />
    &lt;transportConnectors&gt;<br />
      &lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://localhost:61616&quot; /&gt;<br />
    &lt;/transportConnectors&gt;<br />
  &lt;/broker&gt;<br />
&lt;/beans&gt;<br />
[/sourcecode]</p>
<h3>Support JNDI</h3>
<p>Il est nécessaire de récupérer certaines informations depuis un contexte JNDI pour créer une connexion au provider JMS ActiveMQ.<br />
Créer un fichier <strong>jndi.properties</strong> dans le répertoire <strong>src/main/resources</strong></p>
<p>[sourcecode language="text"]<br />
java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory<br />
java.naming.provider.url=tcp://localhost:61616<br />
queue.queue1 = example.queue1<br />
[/sourcecode]</p>
<p>Ensuite, nous allons créer un Producer et un Consumer pour poster et consommer les messages.</p>
<h2>Le Producer</h2>
<p>Nous allons créer un Producer qui envoie des messages à la file de messages. Le Producer prendra en paramètre:</p>
<ul>
<li>la file de messages de destination</li>
<li>le nombre de messages à envoyer. Si non renseigné, un seul message sera envoyé</li>
<li>la priorité des messages. Si non renseignée, la priorité est aléatoire (entre 0 et 9)</li>
</ul>
<p>Créer une classe <strong>Producer</strong> dans le répertoire <strong>src/main/java/com/mycompany/messaging</strong>:</p>
<p>[sourcecode language="java"]<br />
package com.mycompany.messaging;</p>
<p>import javax.jms.Connection;<br />
import javax.jms.ConnectionFactory;<br />
import javax.jms.DeliveryMode;<br />
import javax.jms.Destination;<br />
import javax.jms.JMSException;<br />
import javax.jms.Message;<br />
import javax.jms.MessageProducer;<br />
import javax.jms.Session;<br />
import javax.jms.TextMessage;<br />
import javax.naming.Context;<br />
import javax.naming.InitialContext;<br />
import javax.naming.NamingException;</p>
<p>public class Producer {</p>
<p>    public static void main(String[] args) {<br />
        Context jndiContext = null;<br />
        ConnectionFactory connectionFactory = null;<br />
        Connection connection = null;<br />
        Session session = null;<br />
        Destination destination = null;<br />
        MessageProducer producer = null;<br />
        String destinationName = null;<br />
        int numMsgs = 1;<br />
        int priority = -1;</p>
<p>        if ((args.length &lt; 1) || (args.length &gt; 3)) {<br />
            System.out<br />
                            .println(&quot;Usage: java Producer &lt;destination-name&gt; [&lt;number-of-messages&gt;] [&lt;priority-of-messages&gt;]&quot;);<br />
            System.exit(1);<br />
        }<br />
        destinationName = args[0];<br />
        System.out.println(&quot;Destination name is &quot; + destinationName);<br />
        if (args.length &gt;= 2) {<br />
            numMsgs = Integer.valueOf(args[1]);<br />
        }<br />
        if (args.length == 3) {<br />
            priority = Integer.valueOf(args[2]);<br />
        }<br />
        try {<br />
            jndiContext = new InitialContext();<br />
            connectionFactory = (ConnectionFactory ) jndiContext.lookup(&quot;ConnectionFactory&quot;);<br />
            destination = (Destination ) jndiContext.lookup(destinationName);<br />
        } catch (NamingException e) {<br />
            e.printStackTrace();<br />
            System.exit(1);<br />
        }</p>
<p>        try {<br />
            connection = connectionFactory.createConnection();<br />
            session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);<br />
            producer = session.createProducer(destination);<br />
            TextMessage message = session.createTextMessage();<br />
            for (int i = 0; i &lt; numMsgs; i++) {<br />
                message.setText(&quot;This is message &quot; + i);<br />
                int p = priority;<br />
                if (priority == -1) {<br />
                    p = (int ) (Math.random() * 10);<br />
                }<br />
                System.out.println(&quot;Sending message: &quot; + message.getText() + &quot; with priority: &quot; + p);<br />
                producer.send(message, DeliveryMode.PERSISTENT, p, Message.DEFAULT_TIME_TO_LIVE);<br />
            }<br />
        } catch (JMSException e) {<br />
            e.printStackTrace();<br />
        } finally {<br />
            try {<br />
                jndiContext.close();<br />
            } catch (NamingException e1) {<br />
            }<br />
            if (connection != null) {<br />
                try {<br />
                    connection.stop();<br />
                    connection.close();<br />
                } catch (JMSException e) {<br />
                }<br />
            }<br />
        }<br />
    }<br />
}<br />
[/sourcecode]</p>
<h2>Le Consumer</h2>
<p>Nous allons créer un Consumer qui consomme les messages de la file. Le Consumer prendra en paramètre:</p>
<ul>
<li>la file de messages</li>
</ul>
<p>Créer une classe <strong>Consumer</strong> dans le répertoire <strong>src/main/java/com/mycompany/messaging</strong>:</p>
<p>[sourcecode language="java"]<br />
package com.mycompany.messaging;</p>
<p>import javax.jms.Connection;<br />
import javax.jms.ConnectionFactory;<br />
import javax.jms.ConnectionMetaData;<br />
import javax.jms.Destination;<br />
import javax.jms.JMSException;<br />
import javax.jms.Message;<br />
import javax.jms.MessageConsumer;<br />
import javax.jms.Session;<br />
import javax.jms.TextMessage;<br />
import javax.naming.Context;<br />
import javax.naming.InitialContext;<br />
import javax.naming.NamingException;</p>
<p>public class Consumer {</p>
<p>    public static void main(String[] args) {<br />
        Context jndiContext = null;<br />
        ConnectionFactory connectionFactory = null;<br />
        Connection connection = null;<br />
        Session session = null;<br />
        Destination destination = null;<br />
        MessageConsumer consumer = null;<br />
        String destinationName = null;</p>
<p>        if ((args.length &lt; 1) || (args.length &gt; 1)) {<br />
            System.out.println(&quot;Usage: java Consumer &lt;destination-name&gt;&quot;);<br />
            System.exit(1);<br />
        }<br />
        destinationName = args[0];<br />
        System.out.println(&quot;Destination name is &quot; + destinationName);</p>
<p>        try {<br />
            jndiContext = new InitialContext();<br />
            connectionFactory = (ConnectionFactory ) jndiContext.lookup(&quot;ConnectionFactory&quot;);<br />
            destination = (Destination ) jndiContext.lookup(destinationName);<br />
        } catch (NamingException e) {<br />
            e.printStackTrace();<br />
            System.exit(1);<br />
        }</p>
<p>        try {<br />
            connection = connectionFactory.createConnection();<br />
            connection.start();<br />
            session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);<br />
            consumer = session.createConsumer(destination);</p>
<p>            while (true) {<br />
                Message message = consumer.receive(2000);<br />
                if (message == null) {<br />
                    System.out.println(&quot;waiting...&quot;);<br />
                    continue;<br />
                }<br />
                if (message instanceof TextMessage) {<br />
                    TextMessage txtMessage = (TextMessage ) message;<br />
                    System.out.println(&quot;Message received: &quot; + txtMessage.getText() + &quot;, priority:&quot;<br />
                                    + txtMessage.getJMSPriority());<br />
                } else {<br />
                    System.out.println(&quot;Invalid message received.&quot;);<br />
                }<br />
                Thread.sleep(100);<br />
            }</p>
<p>        } catch (Exception e) {<br />
            e.printStackTrace();<br />
        } finally {<br />
            try {<br />
                jndiContext.close();<br />
            } catch (NamingException e) {<br />
                e.printStackTrace();<br />
            }<br />
            try {<br />
                connection.close();<br />
            } catch (JMSException e) {<br />
                e.printStackTrace();<br />
            }<br />
        }<br />
    }<br />
}<br />
[/sourcecode]</p>
<h1>La partie Build  et Run</h1>
<h2>Run du Prodiver JMS</h2>
<p>Pour lancer le provider JMS ActiveMQ, il suffit d'exécuter la commande maven suivante:</p>
<pre>$ mvn activemq:run
...
INFO: ActiveMQ JMS Message Broker (localhost, ID:GF106903-1477-1301046394468-0:1) started</pre>
<p>Le provider JMS ActiveMQ est démarré!</p>
<h2>Envoi des messages</h2>
<p>Créer 10 messages de priorité aléatoire (0 à 9) et les poster dans la file de messages "queue1":</p>
<pre>$ mvn clean compile exec:java -Dexec.mainClass=com.mycompany.messaging.Producer -Dexec.args="queue1 10"
...
Sending message: This is message 0 with priority: <strong><span style="color:red;">8</span></strong>
Sending message: This is message 1 with priority: <strong><span style="color:red;">9</span></strong>
Sending message: This is message 2 with priority: <strong><span style="color:red;">4</span></strong>
Sending message: This is message 3 with priority: <strong><span style="color:red;">6</span></strong>
Sending message: This is message 4 with priority: <strong><span style="color:red;">2</span></strong>
Sending message: This is message 5 with priority: <strong><span style="color:red;">8</span></strong>
Sending message: This is message 6 with priority: <strong><span style="color:red;">8</span></strong>
Sending message: This is message 7 with priority: <strong><span style="color:red;">8</span></strong>
Sending message: This is message 8 with priority: <strong><span style="color:red;">9</span></strong>
Sending message: This is message 9 with priority: <strong><span style="color:red;">0</span></strong>
...</pre>
<h2>Consommation des messages</h2>
<p>Consommer les messages depuis la file de message "queue1":</p>
<pre>$ mvn clean compile exec:java -Dexec.mainClass=com.mycompany.messaging.Consumer -Dexec.args="queue1"
...
Message received: This is message 1, priority:<strong><span style="color:red;">9</span></strong>
Message received: This is message 8, priority:<strong><span style="color:red;">9</span></strong>
Message received: This is message 0, priority:<strong><span style="color:red;">8</span></strong>
Message received: This is message 5, priority:<strong><span style="color:red;">8</span></strong>
Message received: This is message 6, priority:<strong><span style="color:red;">8</span></strong>
Message received: This is message 7, priority:<strong><span style="color:red;">8</span></strong>
Message received: This is message 3, priority:<strong><span style="color:red;">6</span></strong>
Message received: This is message 2, priority:<strong><span style="color:red;">4</span></strong>
Message received: This is message 4, priority:<strong><span style="color:red;">2</span></strong>
Message received: This is message 9, priority:<strong><span style="color:red;">0</span></strong>
...</pre>
<p>Les messages ont été réordonnés par le provider JMS et les messages ont donc été consommés par ordre de priorité.</p>
<h1>Conclusion</h1>
<p>La priorité des messages est soit spécifiée dans le <a href="http://download.oracle.com/javaee/6/api/javax/jms/MessageProducer.html">MessageProducer</a> ou bien comme paramètre de la méthode <a href="http://download.oracle.com/javaee/6/api/javax/jms/MessageProducer.html#send(javax.jms.Destination, javax.jms.Message, int, int, long)">send</a>.</p>
<p>L'erreur fréquente est de spécifier la priorité dans l'objet <a href="http://download.oracle.com/javaee/6/api/javax/jms/Message.html">Message</a>. La méthode <a href="http://download.oracle.com/javaee/6/api/javax/jms/Message.html#setJMSPriority(int)">setJMSPriority</a> de la classe <a href="http://download.oracle.com/javaee/6/api/javax/jms/Message.html">Message</a> est appelée par le provider JMS pour définir la priorité du message à envoyer dans la file de messages.</p>
<p>[sourcecode language="java"]<br />
      // Correct<br />
      producer.send(message, DeliveryMode.PERSISTENT, priority, Message.DEFAULT_TIME_TO_LIVE);<br />
      // ou bien<br />
      producer.setJMSPriority(priority);<br />
      producer.send(message);</p>
<p>      // Incorrect<br />
      message.setJMSPriority(priority);<br />
      producer.send(message);<br />
[/sourcecode]</p>
<h1>Références</h1>
<ul>
<li><a href="http://code.google.com/p/vince/source/browse/#svn%2Ftrunk%2Fmessaging%2Fproducer" target="_blank">Code source de l'exemple sur Google Code</a></li>
<li><a href="http://activemq.apache.org" target="_blank">Apache ActiveMQ</a></li>
<li><a href="http://activemq.apache.org/jndi-support.html" target="_blank">ActiveMQ JNDI Support</a></li>
<li><a href="http://activemq.apache.org/maven2-activemq-broker-plugin.html" target="_blank">Maven2 ActiveMQ Broker Plugin</a></li>
<li><a href="http://pookey.co.uk/wordpress/archives/74-playing-with-activemq-using-maven" target="_blank">Playing with ActiveMQ using Maven</a></li>
<li><a href="http://www.eaipatterns.com/Resequencer.html" target="_blank">EAI Patterns: Resequencer</a></li>
</ul>
